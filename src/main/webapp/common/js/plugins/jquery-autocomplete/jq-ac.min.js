(function($){"use strict";$.Autocompleter=function($elem,options){this.cacheData_={};this.cacheLength_=0;this.selectClass_='jquery-autocomplete-selected-item';this.keyTimeout_=null;this.lastKeyPressed_=null;this.lastProcessedValue_=null;this.lastSelectedValue_=null;this.active_=false;this.finishOnBlur_=true;if(!$elem||!($elem instanceof jQuery)||$elem.length!==1||$elem.get(0).tagName.toUpperCase()!=='INPUT'){window.alert('Invalid parameter for jquery.Autocompleter, jQuery object with one element with INPUT tag expected');return false;}$elem.attr('autocomplete','off');if(typeof options==='string'){this.options={url:options};}else{this.options=options;}this.options.minChars=parseInt(this.options.minChars,10);if(isNaN(this.options.minChars)){this.options.minChars=2;}this.options.maxItemsToShow=parseInt(this.options.maxItemsToShow,10);if(isNaN(this.options.maxItemsToShow)||this.options.maxItemsToShow<1){this.options.maxItemsToShow=10;}this.options.maxCacheLength=parseInt(this.options.maxCacheLength,10);if(isNaN(this.options.maxCacheLength)||this.options.maxCacheLength<1){this.options.maxCacheLength=10;}this.dom={};this.dom.$elem=$elem;if(this.options.inputClass){this.dom.$elem.addClass(this.options.inputClass);}this.dom.$results=$('<div></div>').hide();if(this.options.resultsClass){this.dom.$results.addClass(this.options.resultsClass);}this.dom.$results.css({position:'absolute'});$('body').append(this.dom.$results);var self=this;var btnChoose=$elem.siblings('span.choose');if(btnChoose.length){btnChoose.click(function(e){e.preventDefault();self.disableFinishOnBlur();if(self.active_){self.finish();}else{self.activate('force');}self.enableFinishOnBlur();});}$elem.keyup(function(e){self.lastKeyPressed_=e.keyCode;switch(self.lastKeyPressed_){case 38:e.preventDefault();if(self.active_){self.focusPrev();}else{self.activate();}return false;case 40:e.preventDefault();if(self.active_){self.focusNext();}else{self.activate();}return false;case 9:if(self.active_){self.selectCurrent();if(self.options.preventDefaultTab){e.preventDefault();return false;}}break;case 13:if(self.active_){self.selectCurrent();if(self.options.preventDefaultReturn){e.preventDefault();return false;}}break;case 27:if(self.active_){e.preventDefault();self.finish();return false;}break;default:if(self.options.filterResults||!btnChoose.length){self.activate();}}});$elem.focus(function(e){if(!self.active_&&(self.options.filterResults||!btnChoose.length)){self.activate();}});$elem.bind('ac-finish',function(e){e.preventDefault();e.stopPropagation();self.finish();});};$.Autocompleter.prototype.position=function(){var offset=this.dom.$elem.offset();this.dom.$results.css({top:offset.top+this.dom.$elem.outerHeight(),left:offset.left});};$.Autocompleter.prototype.cacheRead=function(filter){var filterLength,searchLength,search,maxPos,pos;if(this.options.useCache){filter=String(filter);filterLength=filter.length;if(this.options.matchSubset){searchLength=1;}else{searchLength=filterLength;}while(searchLength<=filterLength){if(this.options.matchInside){maxPos=filterLength-searchLength;}else{maxPos=0;}pos=0;while(pos<=maxPos){search=filter.substr(0,searchLength);if(this.cacheData_[search]!==undefined){return this.cacheData_[search];}pos++;}searchLength++;}}return false;};$.Autocompleter.prototype.cacheWrite=function(filter,data){if(this.options.useCache){if(this.cacheLength_>=this.options.maxCacheLength){this.cacheFlush();}filter=String(filter);if(this.cacheData_[filter]!==undefined){this.cacheLength_++;}this.cacheData_[filter]=data;return this.cacheData_[filter];}return false;};$.Autocompleter.prototype.cacheFlush=function(){this.cacheData_={};this.cacheLength_=0;};$.Autocompleter.prototype.callHook=function(hook,data){var f=this.options[hook];if(f&&$.isFunction(f)){return f(data,this);}return false;};$.Autocompleter.prototype.activate=function(force){this.activateNow(force);};$.Autocompleter.prototype.activateNow=function(force){var value=this.beforeUseConverter(this.dom.$elem.val());if(force||(value!==this.lastProcessedValue_&&value!==this.lastSelectedValue_)){if(value.length>=this.options.minChars){this.lastProcessedValue_=value;this.fetchData(value);}}};$.Autocompleter.prototype.fetchData=function(value){var flag=true;if(this.options.fetchRemoteDataFilter){flag=this.options.fetchRemoteDataFilter(value);}if(!flag){this.finish();return;}if(this.options.data){this.filterAndShowResults(this.options.data,value);}else if(this.options.getData){this.filterAndShowResults(this.options.getData(value),value);}else{var self=this;this.fetchRemoteData(value,function(remoteData){self.filterAndShowResults(remoteData,value);});}};$.Autocompleter.prototype.fetchRemoteData=function(filter,callback){var data=this.cacheRead(filter);if(data){callback(data);}else{var self=this;this.dom.$elem.addClass(this.options.loadingClass);var ajaxCallback=function(data){var parsed=false;if(data!==false){parsed=self.parseRemoteData(data);self.cacheWrite(filter,parsed);}self.dom.$elem.removeClass(self.options.loadingClass);callback(parsed);};$.ajax({url:this.makeUrl(filter),success:ajaxCallback,error:function(){ajaxCallback(false);},dataType:'text'});}};$.Autocompleter.prototype.setExtraParam=function(name,value){var index=$.trim(String(name));if(index){if(!this.options.extraParams){this.options.extraParams={};}if(this.options.extraParams[index]!==value){this.options.extraParams[index]=value;this.cacheFlush();}}};$.Autocompleter.prototype.makeUrl=function(param){var self=this;var url=this.options.url;var params=$.extend({},this.options.extraParams);if(this.options.queryParamName===false){url+=encodeURIComponent(param);}else{params[this.options.queryParamName]=param;}if(this.options.limitParamName&&this.options.maxItemsToShow){params[this.options.limitParamName]=this.options.maxItemsToShow;}var urlAppend=[];$.each(params,function(index,value){urlAppend.push(self.makeUrlParam(index,value));});if(urlAppend.length){url+=url.indexOf('?')===-1?'?':'&';url+=urlAppend.join('&');}return url;};$.Autocompleter.prototype.makeUrlParam=function(name,value){return[name,encodeURIComponent(value)].join('=');};$.Autocompleter.prototype.parseRemoteData=function(remoteData){var remoteDataType=this.options.remoteDataType;if(remoteDataType==='json'){return this.parseRemoteJSON(remoteData);}return this.parseRemoteText(remoteData);};$.Autocompleter.prototype.parseRemoteText=function(remoteData){var results=[];var text=String(remoteData).replace('\r\n',this.options.lineSeparator);var i,j,data,line,lines=text.split(this.options.lineSeparator);var value;for(i=0;i<lines.length;i++){line=lines[i].split(this.options.cellSeparator);data=[];for(j=0;j<line.length;j++){data.push(decodeURIComponent(line[j]));}value=data.shift();results.push({value:value,data:data});}return results;};$.Autocompleter.prototype.parseRemoteJSON=function(remoteData){return $.parseJSON(remoteData);};$.Autocompleter.prototype.filterAndShowResults=function(results,filter){if(this.options.processData){results=this.options.processData(results);}this.showResults(this.filterResults(results,filter),filter);};$.Autocompleter.prototype.filterResults=function(results,filter){var filtered=[];var value,data,i,result,type,include;var pattern,testValue;for(i=0;i<results.length;i++){result=results[i];type=typeof result;if(type==='string'){value=result;data={};}else if($.isArray(result)){value=result[0];data=result.slice(1);}else if(type==='object'){value=result.value;data=result.data;}value=String(value);if(value>''){if(typeof data!=='object'){data={};}if(this.options.filterResults){pattern=this.matchStringConverter(filter);testValue=this.matchStringConverter(value);if(this.options.matchLabel){testValue=this.showResult(value,data);}if(!this.options.matchCase){pattern=pattern.toLowerCase();testValue=testValue.toLowerCase();}include=testValue.indexOf(pattern);if(this.options.matchInside){include=include>-1;}else{include=include===0;}}else{include=true;}if(include){filtered.push({value:value,data:data});}}}if(this.options.sortResults){filtered=this.sortResults(filtered,filter);}if(this.options.maxItemsToShow>0&&this.options.maxItemsToShow<filtered.length){filtered.length=this.options.maxItemsToShow;}return filtered;};$.Autocompleter.prototype.sortResults=function(results,filter){var self=this;var sortFunction=this.options.sortFunction;if(!$.isFunction(sortFunction)){sortFunction=function(a,b,f){return self.sortValueAlpha(a,b,f);};}results.sort(function(a,b){return sortFunction(a,b,filter);});return results;};$.Autocompleter.prototype.sortValueAlpha=function(a,b,filter){a=String(a.value);b=String(b.value);if(!this.options.matchCase){a=a.toLowerCase();b=b.toLowerCase();}if(a>b){return 1;}if(a<b){return-1;}return 0;};$.Autocompleter.prototype.matchStringConverter=function(s,a,b){var converter=this.options.matchStringConverter;if($.isFunction(converter)){s=converter(s,a,b);}return s;};$.Autocompleter.prototype.beforeUseConverter=function(s,a,b){var converter=this.options.beforeUseConverter;if($.isFunction(converter)){s=converter(s,a,b);}return s;};$.Autocompleter.prototype.enableFinishOnBlur=function(){this.finishOnBlur_=true;};$.Autocompleter.prototype.disableFinishOnBlur=function(){this.finishOnBlur_=false;};$.Autocompleter.prototype.createItemFromResult=function(result){var self=this;var $li=$('<li>'+this.showResult(result.value,result.data)+'</li>');$li.data('value',result.value);$li.data('data',result.data);$li.click(function(){self.selectItem($li);}).mousedown(self.disableFinishOnBlur).mouseup(self.enableFinishOnBlur);return $li;};$.Autocompleter.prototype.showResults=function(results,filter){var numResults=results.length;if(numResults===0){return this.finish();}var self=this;var $ul=$('<ul></ul>');var i,result,$li,autoWidth,first=false,$first=false;for(i=0;i<numResults;i++){result=results[i];$li=this.createItemFromResult(result);$ul.append($li);if(first===false){first=String(result.value);$first=$li;$li.addClass(this.options.firstItemClass);}if(i===numResults-1){$li.addClass(this.options.lastItemClass);}}this.position();this.dom.$results.html($ul).show();if(this.options.autoWidth){autoWidth=this.dom.$elem.outerWidth()-this.dom.$results.outerWidth()+this.dom.$results.width();this.dom.$results.css(this.options.autoWidth,autoWidth);}$('li',this.dom.$results).hover(function(){self.focusItem(this);},function(){});if(this.autoFill(first,filter)||this.options.selectFirst||(this.options.selectOnly&&numResults===1)){this.focusItem($first);}this.active_=true;};$.Autocompleter.prototype.showResult=function(value,data){if($.isFunction(this.options.showResult)){return this.options.showResult(value,data);}else{return value;}};$.Autocompleter.prototype.autoFill=function(value,filter){var lcValue,lcFilter,valueLength,filterLength;if(this.options.autoFill&&this.lastKeyPressed_!==8){lcValue=String(value).toLowerCase();lcFilter=String(filter).toLowerCase();valueLength=value.length;filterLength=filter.length;if(lcValue.substr(0,filterLength)===lcFilter){this.dom.$elem.val(value);this.selectRange(filterLength,valueLength);return true;}}return false;};$.Autocompleter.prototype.focusNext=function(){this.focusMove(+1);};$.Autocompleter.prototype.focusPrev=function(){this.focusMove(-1);};$.Autocompleter.prototype.focusMove=function(modifier){var $items=$('li',this.dom.$results);modifier=parseInt(modifier,10);for(var i=0;i<$items.length;i++){if($($items[i]).hasClass(this.selectClass_)){this.focusItem(i+modifier);return;}}this.focusItem(0);};$.Autocompleter.prototype.focusItem=function(item){var $item,$items=$('li',this.dom.$results);if($items.length){$items.removeClass(this.selectClass_).removeClass(this.options.selectClass);if(typeof item==='number'){item=parseInt(item,10);if(item<0){item=0;}else if(item>=$items.length){item=$items.length-1;}$item=$($items[item]);}else{$item=$(item);}if($item){$item.addClass(this.selectClass_).addClass(this.options.selectClass);}}};$.Autocompleter.prototype.selectCurrent=function(){var $item=$('li',this.dom.$results);var $itemSelected=$item.filter('.'+this.selectClass_);if($itemSelected.length===1){this.selectItem($itemSelected);}else{if($item.length){this.selectItem($item.eq(0));}else{this.finish();}}};$.Autocompleter.prototype.selectItem=function($li){var value=$li.data('value');var data=$li.data('data');var displayValue=this.displayValue(value,data);var processedDisplayValue=this.beforeUseConverter(displayValue);this.lastProcessedValue_=processedDisplayValue;this.lastSelectedValue_=processedDisplayValue;this.dom.$elem.val(displayValue).focus();this.setCaret(displayValue.length);this.callHook('onItemSelect',{value:value,data:data});this.finish();};$.Autocompleter.prototype.displayValue=function(value,data){if($.isFunction(this.options.displayValue)){return this.options.displayValue(value,data);}else{return value;}};$.Autocompleter.prototype.finish=function(){if(this.keyTimeout_){clearTimeout(this.keyTimeout_);}if(this.beforeUseConverter(this.dom.$elem.val())!==this.lastSelectedValue_){if(this.options.mustMatch){this.dom.$elem.val('');}this.callHook('onNoMatch');}this.dom.$results.hide();this.lastKeyPressed_=null;this.lastProcessedValue_=null;if(this.active_){this.callHook('onFinish');}this.active_=false;};$.Autocompleter.prototype.selectRange=function(start,end){var input=this.dom.$elem.get(0);if(input.setSelectionRange){input.focus();input.setSelectionRange(start,end);}else if(this.createTextRange){var range=this.createTextRange();range.collapse(true);range.moveEnd('character',end);range.moveStart('character',start);range.select();}};$.Autocompleter.prototype.setCaret=function(pos){this.selectRange(pos,pos);};$.fn.autocomplete=function(options){var url;if(arguments.length>1){url=options;options=arguments[1];options.url=url;}else if(typeof options==='string'){url=options;options={url:url};}var o=$.extend({},$.fn.autocomplete.defaults,options);return this.each(function(){var $this=$(this);var ac=new $.Autocompleter($this,o);$this.data('autocompleter',ac);});};$.fn.autocomplete.defaults={inputClass:'acInput',loadingClass:'acLoading',resultsClass:'acResults',selectClass:'acSelect',queryParamName:'q',limitParamName:'limit',extraParams:{},remoteDataType:false,lineSeparator:'\n',cellSeparator:'|',minChars:0,maxItemsToShow:10,delay:400,useCache:true,maxCacheLength:10,matchSubset:true,matchCase:false,matchInside:true,mustMatch:false,selectFirst:false,selectOnly:false,showResult:null,preventDefaultReturn:true,preventDefaultTab:false,autoFill:false,filterResults:true,sortResults:true,sortFunction:null,onItemSelect:null,onNoMatch:null,onFinish:null,matchStringConverter:null,beforeUseConverter:null,autoWidth:'min-width',matchLabel:true};})(jQuery);